{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Lorry Fleet Tracker</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        #map { height: 75vh; width: 100%; border: 1px solid #ddd; }
        .lorry-card { cursor: pointer; }
        .lorry-card:hover { background-color: #e9ecef; }
        body { padding-top: 20px; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row mb-3">
            <div class="col-12">
                <h1 class="text-primary">üöõ Lorry Fleet Tracker</h1>
                <p class="text-muted">Live tracking across Ireland with county boundaries</p>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-truck"></i> Fleet Status</h5>
                    </div>
                    <div class="card-body p-0">
                        <div id="lorry-list" class="list-group list-group-flush">
                            <div class="list-group-item text-center p-4">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                Loading fleet...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-9">
                <div id="map"></div>
                <div class="mt-2 text-center">
                    <button class="btn btn-outline-primary" onclick="updateFleet()" id="refresh-btn">
                        üîÑ Refresh Fleet
                    </button>
                    <button class="btn btn-outline-secondary ms-2" onclick="toggleCounties()" id="toggle-counties-btn">
                        üó∫Ô∏è Show County Borders
                    </button>
                    <button class="btn btn-outline-success ms-2" onclick="toggleLiveLocation()" id="live-location-btn">
                        üì° Start Live Location
                    </button>
                    <div class="small text-muted mt-2" id="route-status">
                        Click a lorry to set the origin, then click the map to set a destination.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize map centered on Ireland
        const map = L.map('map').setView([53.35, -8.0], 7);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);
        map.on('click', handleMapClick);

        const lorryMarkers = {};
        let countyLayer = null;
        let countiesVisible = false;
        let countiesDataPromise = null;
        let selectedOrigin = null;
        let selectedDestination = null;
        let routeLine = null;
        let destinationMarker = null;

        // Config for posting live browser location to backend
        const liveUpdateConfig = {
            lorryId: 2, // JakeMac
            ingestUrl: '/api/ingest-location/',
            ingestToken: 'devtoken' // change for production; matches settings.INGEST_TOKEN
        };
        const routingConfig = {
            endpoint: '/api/route/'
        };

        // Track user's live location
        let liveLocationWatchId = null;
        let userMarker = null;
        let hasCenteredOnUser = false;

        const countiesUrl = "{% static 'tracking/data/CountyBordersGeoJSON.geojson' %}";

        function updateFleet() {
            document.getElementById('refresh-btn').disabled = true;
            document.getElementById('refresh-btn').innerHTML = 'üîÑ Updating...';
            
            fetch('/api/latest-locations/')
                .then(response => response.json())
                .then(data => {
                    let listHtml = '';
                    
                    data.forEach(location => {
                        const lat = location.latitude;
                        const lon = location.longitude;
                        if (lat === null || lon === null || lat === undefined || lon === undefined) {
                            return; // skip entries without coordinates
                        }
                        const lorryId = location.lorry;
                        const lorryName = location.lorry_name;
                        const popupHtml = `<b>${lorryName}</b><br>${lat.toFixed(4)}, ${lon.toFixed(4)}`;
                        
                        // Update list
                        listHtml += `
                            <div class="list-group-item d-flex justify-content-between align-items-center lorries-card" data-id="${lorryId}">
                                <div>
                                    <strong>${lorryName}</strong><br>
                                    <small class="text-muted">${new Date(location.timestamp).toLocaleString()}</small>
                                </div>
                                <span class="badge bg-primary rounded-pill">${lat.toFixed(4)}, ${lon.toFixed(4)}</span>
                            </div>
                        `;
                        
                        // Update map marker
                        if (lorryMarkers[lorryId]) {
                            lorryMarkers[lorryId].setLatLng([lat, lon]).bindPopup(popupHtml);
                        } else {
                            lorryMarkers[lorryId] = L.marker([lat, lon], {
                                icon: L.divIcon({
                                    className: 'lorry-marker',
                                    html: 'üöõ',
                                    iconSize: [30, 30],
                                    iconAnchor: [15, 15]
                                })
                            })
                            .addTo(map)
                            .bindPopup(popupHtml);
                        }

                        attachLorryClick(lorryId, lorryName, lorryMarkers[lorryId]);
                    });
                    
                    document.getElementById('lorry-list').innerHTML = listHtml || '<div class="list-group-item text-center text-muted p-4">No lorries online</div>';
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('lorry-list').innerHTML = '<div class="list-group-item text-center text-danger p-4">Error loading fleet</div>';
                })
                .finally(() => {
                    document.getElementById('refresh-btn').disabled = false;
                    document.getElementById('refresh-btn').innerHTML = 'üîÑ Refresh Fleet';
                });
        }

        // Auto-refresh every 15 seconds
        updateFleet();
        setInterval(updateFleet, 15000);

        function loadCountyData() {
            if (!countiesDataPromise) {
                countiesDataPromise = fetch(countiesUrl).then(resp => resp.json());
            }
            return countiesDataPromise;
        }

        function toggleCounties() {
            const btn = document.getElementById('toggle-counties-btn');
            if (countiesVisible) {
                if (countyLayer) {
                    map.removeLayer(countyLayer);
                }
                countiesVisible = false;
                btn.innerHTML = 'üó∫Ô∏è Show County Borders';
                return;
            }

            btn.disabled = true;
            btn.innerHTML = 'üó∫Ô∏è Loading...';

            loadCountyData()
                .then(geojson => {
                    if (!countyLayer) {
                        countyLayer = L.geoJSON(geojson, {
                            style: {
                                color: '#1d4ed8',
                                weight: 2,
                                fill: false
                            }
                        }).addTo(map);
                    } else {
                        countyLayer.addTo(map);
                    }
                    countiesVisible = true;
                    btn.innerHTML = 'üó∫Ô∏è Hide County Borders';
                })
                .catch(err => {
                    console.error('Error loading county borders:', err);
                    btn.innerHTML = 'üó∫Ô∏è Show County Borders';
                })
                .finally(() => {
                    btn.disabled = false;
                });
        }

        function startLiveLocation() {
            const btn = document.getElementById('live-location-btn');
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by your browser.');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = 'üì° Starting...';

            liveLocationWatchId = navigator.geolocation.watchPosition(
                (position) => {
                    handleLiveLocationUpdate(position.coords.latitude, position.coords.longitude);
                    btn.innerHTML = '‚è∏Ô∏è Stop Live Location';
                    btn.disabled = false;
                },
                (err) => {
                    console.warn('Failed to get location:', err);
                    alert('Unable to access your location.');
                    stopLiveLocation();
                },
                {
                    enableHighAccuracy: true,
                    maximumAge: 10000,
                    timeout: 20000
                }
            );
        }

        function stopLiveLocation() {
            const btn = document.getElementById('live-location-btn');
            if (liveLocationWatchId !== null) {
                navigator.geolocation.clearWatch(liveLocationWatchId);
            }
            liveLocationWatchId = null;
            hasCenteredOnUser = false;

            if (userMarker) {
                map.removeLayer(userMarker);
                userMarker = null;
            }

            btn.innerHTML = 'üì° Start Live Location';
            btn.disabled = false;
        }

        function toggleLiveLocation() {
            if (liveLocationWatchId !== null) {
                stopLiveLocation();
            } else {
                startLiveLocation();
            }
        }

        function handleLiveLocationUpdate(lat, lon) {
            const latLng = [lat, lon];

            if (userMarker) {
                userMarker.setLatLng(latLng);
            } else {
                userMarker = L.circleMarker(latLng, {
                    radius: 8,
                    color: '#007bff',
                    fillColor: '#007bff',
                    fillOpacity: 0.9
                })
                .addTo(map)
                .bindPopup('‚Ä¢ Your Location')
                .openPopup();
            }

            if (!hasCenteredOnUser) {
                map.setView(latLng, 13);
                hasCenteredOnUser = true;
            }

            // Send to backend to update lorry position when live toggle is on
            postLiveLocation(lat, lon);
        }

        function postLiveLocation(lat, lon) {
            // Require config to be set; avoid posting with missing auth
            if (!liveUpdateConfig.ingestUrl || !liveUpdateConfig.ingestToken || !liveUpdateConfig.lorryId) {
                return;
            }

            fetch(liveUpdateConfig.ingestUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-INGEST-TOKEN': liveUpdateConfig.ingestToken
                },
                body: JSON.stringify({
                    lorry_id: liveUpdateConfig.lorryId,
                    lat: lat,
                    lon: lon
                })
            }).catch(err => {
                console.warn('Failed to post live location:', err);
            });
        }

        function attachLorryClick(lorryId, lorryName, marker) {
            marker.off('click');
            marker.on('click', () => {
                const { lat, lng } = marker.getLatLng();
                setOrigin(lorryId, lorryName, lat, lng);
            });
        }

        function handleMapClick(e) {
            setDestination(e.latlng.lat, e.latlng.lng);
        }

        function setOrigin(lorryId, lorryName, lat, lon) {
            selectedOrigin = { lorryId, lorryName, lat, lon };
            setRouteStatus(`Origin set to ${lorryName} (${lat.toFixed(4)}, ${lon.toFixed(4)}). Click the map to choose a destination.`, 'info');
            tryFetchRoute();
        }

        function setDestination(lat, lon) {
            selectedDestination = { lat, lon };
            if (destinationMarker) {
                destinationMarker.setLatLng([lat, lon]);
            } else {
                destinationMarker = L.marker([lat, lon], {
                    icon: L.divIcon({
                        className: 'destination-marker',
                        html: 'üéØ',
                        iconSize: [24, 24],
                        iconAnchor: [12, 12]
                    })
                }).addTo(map);
            }
            setRouteStatus(`Destination set at ${lat.toFixed(4)}, ${lon.toFixed(4)}${selectedOrigin ? '. Fetching route‚Ä¶' : '. Click a lorry to set origin.'}`, selectedOrigin ? 'info' : 'muted');
            tryFetchRoute();
        }

        function tryFetchRoute() {
            if (!selectedOrigin || !selectedDestination) {
                return;
            }
            fetchRoute(selectedOrigin, selectedDestination);
        }

        async function fetchRoute(origin, destination) {
            setRouteStatus('Fetching route...', 'info');
            clearRoute();

            const originStr = `${origin.lat.toFixed(5)},${origin.lon.toFixed(5)}`;
            const destStr = `${destination.lat.toFixed(5)},${destination.lon.toFixed(5)}`;

            try {
                const resp = await fetch(`${routingConfig.endpoint}?origin=${originStr}&dest=${destStr}`);
                if (!resp.ok) {
                    const text = await resp.text();
                    throw new Error(text || 'Route request failed');
                }
                const data = await resp.json();
                const route = data.routes && data.routes[0];
                if (!route || !route.legs || !route.legs[0] || !route.legs[0].points) {
                    throw new Error('No route returned');
                }
                drawRoute(route);
            } catch (err) {
                console.error('Route error:', err);
                setRouteStatus(`Unable to fetch route: ${err.message}`, 'error');
            }
        }

        function drawRoute(route) {
            const points = route.legs[0].points.map(p => [p.latitude, p.longitude]);
            routeLine = L.polyline(points, { color: '#16a34a', weight: 5, opacity: 0.8 }).addTo(map);
            map.fitBounds(routeLine.getBounds(), { padding: [30, 30] });

            const summary = route.summary || {};
            const km = summary.lengthInMeters ? (summary.lengthInMeters / 1000).toFixed(1) : null;
            const mins = summary.travelTimeInSeconds ? Math.round(summary.travelTimeInSeconds / 60) : null;
            const stats = km && mins ? `${km} km, ~${mins} min` : 'Route ready';
            setRouteStatus(`${stats} from ${selectedOrigin.lorryName} to destination.`, 'success');
        }

        function clearRoute() {
            if (routeLine) {
                map.removeLayer(routeLine);
                routeLine = null;
            }
        }

        function setRouteStatus(text, tone = 'muted') {
            const el = document.getElementById('route-status');
            if (!el) return;
            el.classList.remove('text-muted', 'text-success', 'text-danger', 'text-primary');
            const cls = tone === 'success' ? 'text-success' : tone === 'error' ? 'text-danger' : tone === 'info' ? 'text-primary' : 'text-muted';
            el.classList.add(cls);
            el.textContent = text;
        }
    </script>
</body>
</html>
